//* This file is part of the MOOSE framework
//* https://www.mooseframework.org
//*
//* All rights reserved, see COPYRIGHT for full restrictions
//* https://github.com/idaholab/moose/blob/master/COPYRIGHT
//*
//* Licensed under LGPL 2.1, please see LICENSE for details
//* https://www.gnu.org/licenses/lgpl-2.1.html

#include "OptimizationParameterTransfer.h"
#include "MultiApp.h"
#include "ControlsReceiver.h"
#include "InputParameterWarehouse.h"

registerMooseObject("OptimizationApp", OptimizationParameterTransfer);

InputParameters
OptimizationParameterTransfer::validParams()
{
  InputParameters params = MultiAppTransfer::validParams();
  params.addClassDescription("Copies optimization data to a ControlsReceiver object.");

  params.addRequiredParam<std::vector<ReporterValueName>>(
      "value_names", "Name of parameter values from OptimizationReporter.");
  params.addRequiredParam<std::vector<std::string>>(
      "parameters",
      "A list of parameters (on the sub application) to control with values from "
      "'parameter_names'.");

  params.addRequiredParam<std::string>("to_control",
                                       "The name of the 'ControlsReceiver' on the sub application "
                                       "to which the optimization parameters will be transferred.");
  params.suppressParameter<MultiAppName>("from_multi_app");

  return params;
}

OptimizationParameterTransfer::OptimizationParameterTransfer(const InputParameters & parameters)
  : MultiAppTransfer(parameters),
    ReporterInterface(this),
    _value_names(getParam<std::vector<ReporterValueName>>("value_names")),
    _parameters(getParam<std::vector<std::string>>("parameters")),
    _receiver_name(getParam<std::string>("to_control"))
{
  if (_value_names.size() != _parameters.size())
    paramError("parameters", "Number of 'value_names' must match number of 'parameters'.");
}

void
OptimizationParameterTransfer::initialSetup()
{
  _values.reserve(_value_names.size());
  for (const auto & name : _value_names)
  {
    ReporterName rname("OptimizationReporter", name);
    _values.push_back(&getReporterValueByName<std::vector<Real>>(rname, REPORTER_MODE_REPLICATED));
  }
}

void
OptimizationParameterTransfer::execute()
{
  std::vector<Real> values_full;
  for (const auto & v : _values)
    values_full.insert(values_full.end(), v->begin(), v->end());

  for (unsigned int i = 0; i < getToMultiApp()->numGlobalApps(); ++i)
    if (getToMultiApp()->hasLocalApp(i))
    {
      ControlsReceiver * ptr = getReceiver(i);
      ptr->transfer(_parameters, values_full);
    }
}

ControlsReceiver *
OptimizationParameterTransfer::getReceiver(unsigned int app_index)
{
  // Test that the sub-application has the given Control object
  FEProblemBase & to_problem = getToMultiApp()->appProblemBase(app_index);
  ExecuteMooseObjectWarehouse<Control> & control_wh = to_problem.getControlWarehouse();
  if (!control_wh.hasActiveObject(_receiver_name))
    mooseError("The sub-application (",
               getToMultiApp()->name(),
               ") does not contain a Control object with the name '",
               _receiver_name,
               "'.");

  ControlsReceiver * ptr =
      dynamic_cast<ControlsReceiver *>(control_wh.getActiveObject(_receiver_name).get());

  if (!ptr)
    mooseError(
        "The sub-application (",
        getToMultiApp()->name(),
        ") Control object for the 'to_control' parameter must be of type 'ControlsReceiver'.");

  return ptr;
}
